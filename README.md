# ğŸ¤ yellow-duck

åˆ©ç”¨çº¿ç¨‹æ± æ‰§è¡Œæ‚¨çš„ Nodejs ç¨‹åº, å¹¶ä¸”ä¿æŒå¤šçº¿ç¨‹ä»£ç ç¼–å†™åœ¨åŸæœ‰æ–‡ä»¶ä¸­.

## èµ·å› 

ç°åœ¨ Nodejs åœ¨ I/O å¯†é›†å‹çš„æ€§èƒ½æ˜¯è¿‡å‰©çš„, è€Œåœ¨å¤šæ ¸ CPU å’Œå†…å­˜åˆ©ç”¨ç‡ä¸Šæ˜¯è½åçš„

<!-- å¦‚æœä»…ä»…å¯åŠ¨è‹¥å¹²ä¸ª Clusterï¼Œç”Ÿäº§æœºå™¨çš„å¤šæ ¸ CPU åˆ©ç”¨ç‡æ— æ³•ä¸Šå»ã€‚ -->

## ç›®æ ‡

- [x] å®ˆæŠ¤è¿›ç¨‹
- [x] æ›´å¥½çš„ worker_threads å¼€å‘ä½“éªŒ
- [x] å¼¹æ€§è°ƒæ•´è¿›ç¨‹æ•°é‡
- [x] å…¼å®¹ I/O å¯†é›†å’Œ CPU å¯†é›†å‹çš„åœºæ™¯
- [ ] è‡ªå¸¦ä¸€å¥—æç®€çš„æ€§èƒ½ç›‘æ§åŠŸèƒ½

## çº¦å®š

- ä¸ºäº†é™ä½ Master çš„å·¥ä½œé‡, å‰åç«¯é€šè®¯å‚æ•°ä»…ç”¨ query å’Œ body

## ç»“æ„

```text
+--------+     +--------+     +--------------------+
| daemon | --> | master | --> | worker threads x n |
+--------+     +--------+     +--------------------+
```

- deamon æ˜¯ä¸»è¿›ç¨‹, å®ƒåšçš„ä»…ä»…æ˜¯å®ˆæŠ¤ master è¿›ç¨‹, ç¡®ä¿å¦‚æœ master æ¶ˆäº¡ä¼šè¿›è¡Œé‡å¯
- master æ˜¯å¤šçº¿ç¨‹çš„ç®¡å®¶, å®ƒä¹Ÿæ˜¯æ•´ä¸ªç¨‹åºçš„å¯¹å¤–çš„æ¥å£, ä½¿ç”¨ fastify è¿›è¡Œè·¯ç”±æ³¨å†Œå’Œç®¡ç†, ä½¿ç”¨ piscina è¿›è¡Œå¤šçº¿ç¨‹å·¥ä½œæ´¾å‘
- worker threads æ ¹æ®ä»»åŠ¡é‡è‡ªåŠ¨ä¼¸ç¼©çš„çº¿ç¨‹, æˆ‘ä»¬çš„ 99%çš„ä»£ç éƒ½åœ¨æ­¤.

## ç¼ºç‚¹

- ä¸ºäº†æ›´å¥½çš„ worker-threas ä»»åŠ¡æ´¾å‘çš„æ€§èƒ½, æ‚¨æ‰€æœ‰ä»£ç çš„åº”è¯¥ä¸ºæƒ°æ€§å‡½æ•°, å³åŠ è½½ worker æ—¶ä¸åº”è¯¥è¢«æ‰§è¡Œ.
- ä»»åŠ¡è¿”å›çš„å¯¹è±¡æš‚æ—¶ä¸æ”¯æŒ stream, æœªæ¥å¯èƒ½å¯ä»¥ä½¿ç”¨ [thread-stream](https://github.com/pinojs/thread-stream) æ”¯æŒæ­¤ç±»åŠŸèƒ½, ä½†æ˜¯ç°åœ¨å®ƒè¿˜å¤ªæ—©äº†.

## Performace

yellowDuck åŸºäº `fastify` å’Œ `piscina`.

è¯šç„¶ï¼Œä½¿ç”¨äº‹ä»¶å¾ªç¯æ˜æ˜¾æ¯”ä½¿ç”¨çº¿ç¨‹æœ‰ç€æ›´é«˜çš„ I/O æ€§èƒ½ï¼Œ æ‰€ä»¥ä½¿ç”¨æ­¤æ–¹æ¡ˆåœ¨çº¯ I/O å¯†é›†ä»»åŠ¡ä¼šæœ‰æ‰€ä¸‹é™ï¼Œä½†æ˜¯ä¾ç„¶ä¿æŒåœ¨ä¸€ä¸ªéå¸¸é«˜çš„æ°´å‡†ï¼›è€Œåœ¨è®¡ç®—å¯†é›†å‹çš„åœºæ™¯ï¼Œæ€§èƒ½æ¥è¿‘äºç­‰é‡ CPU çš„ Cluster å¯åŠ¨ã€‚

å†…å­˜æ–¹é¢ï¼Œç›¸è¾ƒå¯åŠ¨å¤§é‡ Cluster, yellowDuck çš„å†…å­˜å ç”¨ç‡ä¼šå¤§å¹…åº¦ä¸‹é™ï¼›ç›¸è¾ƒäºä»…å¯åŠ¨å•ä¸€ nodejsï¼Œ yellowDuck æœ‰ä¸¤å€çš„å†…å­˜å¼€é”€ã€‚

å¤§ç™½è¯è§£é‡Š: ç‰ºç‰²å°‘éƒ¨åˆ†åŸæœ¬å°±è¿‡å‰©çš„ I/O æ€§èƒ½, æ¢å–å¤šæ ¸ CPU çš„è®¡ç®—æ€§èƒ½æ¦¨å–, åœ¨ I/O æ€§èƒ½ã€è®¡ç®—æ€§èƒ½ã€å†…å­˜åˆ©ç”¨ç‡ä¸Šäº‰å–ç»¼åˆæœ€å¤§åŒ–.

ä»¥ä¸‹æ˜¯ä¸€äº›æµ‹è¯•æ•°æ®ï¼Œæµ‹è¯•æœºå‹: `Apple M1 pro`

### ç©ºé—²

| æ–¹æ¡ˆ                     | QPS | MEM                  |
| ------------------------ | --- | -------------------- |
| node index.js            | -   | 40 MB                |
| pm2 start index.js -i 10 | -   | 400 MB               |
| node yellowDuck.js       | -   | 40 MB + 20(å®ˆæŠ¤è¿›ç¨‹) |

### ç®€å•è¯·æ±‚

| æ–¹æ¡ˆ                     | QPS   | MEM    |
| ------------------------ | ----- | ------ |
| node index.js            | 22889 | 70 MB  |
| pm2 start index.js -i 10 | 20844 | 650 MB |
| node yellowDuck.js       | 14651 | 130 MB |

### æŸ¥è¯¢æ•°æ®åº“ï¼ŒI/O å¯†é›†å‹

| æ–¹æ¡ˆ                     | QPS  | MEM    |
| ------------------------ | ---- | ------ |
| node index.js            | 6718 | 70 MB  |
| pm2 start index.js -i 10 | 4994 | 650 MB |
| node yellowDuck.js       | 6519 | 160 MB |

### I/O å¯†é›†å‹ + CPU å¯†é›†å‹

åœ¨æ¯ä¸ªè¯·æ±‚ä¸­éƒ½è¿›è¡Œä¸€æ¬¡ fibonacci(30) çš„è®¡ç®—

| æ–¹æ¡ˆ                     | QPS  | MEM                        |
| ------------------------ | ---- | -------------------------- |
| node index.js            | 205  | 70 MB                      |
| pm2 start index.js -i 10 | 1584 | è¯·æ±‚ä¸­ 720 MB, ç©ºé—² 650 MB |
| node yellowDuck.js       | 1454 | è¯·æ±‚ä¸­ 250 MB, ç©ºé—² 160MB  |

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºçº¯ I/O å¯†é›†å‹çš„ä»»åŠ¡ï¼Œäº‹ä»¶è½®è®­æ˜¯æœ€é«˜æ•ˆçš„ï¼ŒCluster ã€worker_threads éƒ½æœ‰ä¸€å®šçš„åˆ†æµå¼€é”€ï¼Œè€Œè¦å…¼é¡¾ä¸€å®šçš„è®¡ç®—æ€§èƒ½ï¼Œä½¿ç”¨ worker_threads æ˜¯å¯ä»¥æ¥å—çš„ã€‚

## çº¦å®š

- è·¯ç”±å±‚ç”± yellowDuck ç®¡æ§

## ä½¿ç”¨

é¦–å…ˆç¼–å†™ `worker.js`:

```js
const { yellowDuck } = require("yellow-duck");
const { config } = require("dotenv");

// å‘ yellowDuck æ³¨å†Œè·¯ç”±, è¿™äº›è·¯ç”±ä¼šè¢« master è®°å½•
yellowDuck.get("/v1/hello", async ({body, ctx}) => {
  return { ...body };
});
yellowDuck.post("/v1/world", ({body, ctx}) => {
  return { ...body };
});


// onMaster çš„ä»£ç éƒ½ä»…ä»…ä¼šåœ¨ master ä¸­æ‰§è¡Œ, æ¯”å¦‚å¯åŠ¨ fastify ç¨‹åº:
yellowDuck.onMaster = ({app, ctx}) => {
  // envç¯å¢ƒå˜é‡ä¼šç”±masterä¼ é€’ç»™æ¯ä¸ªçº¿ç¨‹
  config();

  // è€—æ—¶çš„åˆå§‹åŒ–è¯·åœ¨masterè¿›è¡Œ, å¯ä»¥ç»‘å®šåœ¨ ctx ä¸Šï¼Œctxä¼šä¼ é€’ç»™æ¯ä¸ªçº¿ç¨‹
  // æ³¨æ„ä¸å¯ç»‘å®šå‡½æ•°å¯¹è±¡è‡³ ctx ä¸­
  ctx.somebody = {
    hello:"world"
  };

  // æ­¤ä»»åŠ¡ç”±masterå“åº”
  app.get("/master/ping", (req) => {
    return { query: req.query };
  });

  console.log("listen: http://127.0.0.1:3000");
  // å¯åŠ¨æ‚¨çš„ fastify ç¨‹åº
  await app.listen({ port:3000 });
};

// ä½¿ç”¨å¤šçº¿ç¨‹å¯åŠ¨æœåŠ¡
yellowDuck.startWithThreadsPool();

// é™çº§, ä½¿ç”¨å•çº¿ç¨‹å¯åŠ¨æœåŠ¡
// yellowDuck.startWithSingle();

// æœ€åéœ€è¦å¯¼å‡º yellowDuck å¯¹è±¡
// masterServe ä¼šæ¥ç®¡è·¯ç”±ï¼Œå¹¶ä¸”åŒ¹é…å¤šçº¿ç¨‹ä»»åŠ¡
module.exports = yellowDuck;
```

## è·å– headers

ç”±äºéœ€è¦è·¨çº¿ç¨‹é€šè®¯ï¼Œheaders å°½å¯èƒ½ä»…ä¼ é€’å¿…è¦çš„ä¿¡æ¯ï¼Œæ‰€ä»¥ yellowDuck æä¾›äº†ä¸€ä¸ª headersGetter çš„æ–¹æ³•

```ts
yellowDuck.headerGetter = (headers) => {
  // æŒ‘é€‰å¿…è¦çš„header
  return {
    "user-agent": headers["user-agent"],
  };
};

yellowDuck.get("/v1/hello", async ({ headers }) => {
  return { hello: Date.now(), headers };
});
```

### é™çº§åˆ°å•çº¿ç¨‹æ¨¡å¼

å¯ä»¥é€šè¿‡å–æ¶ˆå¯¼å‡º yellowDuck, æ”¹ç”¨ startInWorker çš„æ–¹å¼, æ”¹ä¸ºä¼ ç»Ÿå•çº¿ç¨‹çš„è¿è¡Œæ–¹å¼ã€‚

ä¿®æ”¹ index.js

```js
// ä¿æŒä¸Šé¢åŸæœ‰ä»£ç 
yellowDuck.startWithSingle();

// å–æ¶ˆå¯¼å‡º yellowDuck
// module.exports = yellowDuck;
```

## API

CLI API

| å‚æ•°           | è¯´æ˜                     | é»˜è®¤å€¼              |
| -------------- | ------------------------ | ------------------- |
| --timeout      | æ¯ä¸ªä»»åŠ¡çš„è¶…æ—¶æ—¶é—´       | 10000               |
| --min-threads  | ä¿ç•™çš„æœ€å°çº¿ç¨‹æ•°         | 0                   |
| --max-threads  | ä¿ç•™çš„æœ€å¤§çº¿ç¨‹æ•°         | cups.length         |
| --max-queue    | ç­‰æ‰§è¡Œçš„æœ€å¤§ä»»åŠ¡æ•°       | cups.length \* 1000 |
| --idle-timeout | ä»»åŠ¡ç»“æŸåçº¿ç¨‹ä¿ç•™çš„æ—¶é—´ | 15000               |

---

æ‰§è¡Œå‚æ•°ï¼š

```ts
interface Options {
  filename: string;
  infoUrl?: string;
  timeout?: number;
  minThreads?: number;
  maxThreads?: number;
  maxQueue?: number;
  idleTimeout?: number;
}
```
